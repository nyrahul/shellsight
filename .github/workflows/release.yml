name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create deployment package
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          REPO: ${{ github.repository }}
        run: |
          mkdir -p release-package/nginx

          # Copy nginx config
          cp nginx/nginx.conf release-package/nginx/

          # Copy env example
          cp .env.example release-package/

          # Create docker-compose.yml
          cat > release-package/docker-compose.yml << EOF
          services:
            app:
              image: ghcr.io/${REPO}:${VERSION}
              container_name: shellsight-app
              restart: unless-stopped
              environment:
                - NODE_ENV=production
                - PORT=3001
                - HOST=0.0.0.0
                - AUTH_DISABLED=\${AUTH_DISABLED:-false}
                - SESSION_SECRET=\${SESSION_SECRET:?SESSION_SECRET is required}
                - JWT_SECRET=\${JWT_SECRET:?JWT_SECRET is required}
                - BASE_URL=\${BASE_URL:-http://localhost}
                - FRONTEND_URL=\${FRONTEND_URL:-http://localhost}
                - S3_BUCKET=\${S3_BUCKET:-shellsight-recordings}
                - S3_REGION=\${S3_REGION:-us-east-1}
                - S3_ENDPOINT=\${S3_ENDPOINT:-}
                - S3_PREFIX=\${S3_PREFIX:-}
                - S3_ACCESS_KEY=\${S3_ACCESS_KEY:-}
                - S3_SECRET_KEY=\${S3_SECRET_KEY:-}
                - DEBUG=\${DEBUG:-false}
                - GOOGLE_CLIENT_ID=\${GOOGLE_CLIENT_ID:-}
                - GOOGLE_CLIENT_SECRET=\${GOOGLE_CLIENT_SECRET:-}
                - GITHUB_CLIENT_ID=\${GITHUB_CLIENT_ID:-}
                - GITHUB_CLIENT_SECRET=\${GITHUB_CLIENT_SECRET:-}
                - MICROSOFT_CLIENT_ID=\${MICROSOFT_CLIENT_ID:-}
                - MICROSOFT_CLIENT_SECRET=\${MICROSOFT_CLIENT_SECRET:-}
                - MICROSOFT_TENANT_ID=\${MICROSOFT_TENANT_ID:-common}
                - OIDC_ISSUER=\${OIDC_ISSUER:-}
                - OIDC_CLIENT_ID=\${OIDC_CLIENT_ID:-}
                - OIDC_CLIENT_SECRET=\${OIDC_CLIENT_SECRET:-}
                - OIDC_DISPLAY_NAME=\${OIDC_DISPLAY_NAME:-SSO}
              networks:
                - shellsight-network
              healthcheck:
                test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:3001/auth/providers',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 10s

            nginx:
              image: nginx:alpine
              container_name: shellsight-nginx
              restart: unless-stopped
              ports:
                - "\${HTTP_PORT:-80}:80"
              volumes:
                - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
              depends_on:
                app:
                  condition: service_healthy
              networks:
                - shellsight-network

          networks:
            shellsight-network:
              driver: bridge
          EOF

          # Create deploy.sh
          cat > release-package/deploy.sh << 'SCRIPT'
          #!/bin/bash
          set -e

          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          NC='\033[0m'

          # Default values
          INSTALL_RUSTFS=false
          RUSTFS_ADMIN_USER=""
          RUSTFS_ADMIN_PASSWORD=""

          # Parse command line arguments
          while [[ $# -gt 0 ]]; do
              case $1 in
                  --with-rustfs)
                      INSTALL_RUSTFS=true
                      shift
                      ;;
                  --rustfs-user)
                      RUSTFS_ADMIN_USER="$2"
                      shift 2
                      ;;
                  --rustfs-password)
                      RUSTFS_ADMIN_PASSWORD="$2"
                      shift 2
                      ;;
                  -h|--help)
                      echo "ShellSight Deployment Script"
                      echo ""
                      echo "Usage: ./deploy.sh [options]"
                      echo ""
                      echo "Options:"
                      echo "  --with-rustfs          Install RustFS (S3-compatible storage) alongside ShellSight"
                      echo "  --rustfs-user USER     Set RustFS admin username (default: admin)"
                      echo "  --rustfs-password PASS Set RustFS admin password (default: auto-generated)"
                      echo "  -h, --help             Show this help message"
                      echo ""
                      exit 0
                      ;;
                  *)
                      echo -e "${RED}Unknown option: $1${NC}"
                      echo "Use --help for usage information"
                      exit 1
                      ;;
              esac
          done

          echo -e "${GREEN}========================================"
          echo -e "  ShellSight Deployment"
          echo -e "========================================${NC}"
          echo

          if ! command -v docker &> /dev/null; then
              echo -e "${RED}Error: Docker is not installed.${NC}"
              exit 1
          fi

          if command -v docker-compose &> /dev/null; then
              COMPOSE_CMD="docker-compose"
          elif docker compose version &> /dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
          else
              echo -e "${RED}Error: Docker Compose is not installed.${NC}"
              exit 1
          fi

          echo -e "${GREEN}✓ Docker is installed${NC}"
          echo -e "${GREEN}✓ Docker Compose is available ($COMPOSE_CMD)${NC}"
          echo

          # Ask about RustFS installation if not specified via command line
          if [ "$INSTALL_RUSTFS" = false ]; then
              echo -e "${YELLOW}Do you want to install RustFS (S3-compatible storage) on this VM?${NC}"
              echo "This is useful if you don't have an existing S3 storage."
              read -p "Install RustFS? [y/N]: " install_rustfs_answer
              if [[ "$install_rustfs_answer" =~ ^[Yy]$ ]]; then
                  INSTALL_RUSTFS=true
              fi
          fi

          # Generate RustFS credentials if installing
          if [ "$INSTALL_RUSTFS" = true ]; then
              echo
              echo -e "${BLUE}Setting up RustFS...${NC}"

              if [ -z "$RUSTFS_ADMIN_USER" ]; then
                  RUSTFS_ADMIN_USER="admin"
              fi

              if [ -z "$RUSTFS_ADMIN_PASSWORD" ]; then
                  RUSTFS_ADMIN_PASSWORD=$(openssl rand -base64 16 2>/dev/null | tr -d '/+=' | head -c 16)
                  if [ -z "$RUSTFS_ADMIN_PASSWORD" ]; then
                      RUSTFS_ADMIN_PASSWORD=$(head -c 32 /dev/urandom | base64 | tr -d '/+=' | head -c 16)
                  fi
              fi

              RUSTFS_ACCESS_KEY=$(openssl rand -hex 10 2>/dev/null || head -c 20 /dev/urandom | base64 | tr -d '/+=' | head -c 20)
              RUSTFS_SECRET_KEY=$(openssl rand -hex 20 2>/dev/null || head -c 40 /dev/urandom | base64 | tr -d '/+=' | head -c 40)

              echo -e "${GREEN}✓ Generated RustFS credentials${NC}"
          fi

          if [ ! -f .env ]; then
              echo -e "${YELLOW}Creating .env from template...${NC}"
              cp .env.example .env

              SESSION_SECRET=$(openssl rand -hex 32 2>/dev/null || head -c 64 /dev/urandom | base64 | tr -d '\n' | head -c 64)
              JWT_SECRET=$(openssl rand -hex 32 2>/dev/null || head -c 64 /dev/urandom | base64 | tr -d '\n' | head -c 64)

              if [[ "$OSTYPE" == "darwin"* ]]; then
                  sed -i '' "s/SESSION_SECRET=change-me-to-a-random-string/SESSION_SECRET=$SESSION_SECRET/" .env
                  sed -i '' "s/JWT_SECRET=change-me-to-another-random-string/JWT_SECRET=$JWT_SECRET/" .env
              else
                  sed -i "s/SESSION_SECRET=change-me-to-a-random-string/SESSION_SECRET=$SESSION_SECRET/" .env
                  sed -i "s/JWT_SECRET=change-me-to-another-random-string/JWT_SECRET=$JWT_SECRET/" .env
              fi

              echo -e "${GREEN}✓ Created .env with generated secrets${NC}"
          fi

          # Configure RustFS in .env if installing
          if [ "$INSTALL_RUSTFS" = true ]; then
              if [[ "$OSTYPE" == "darwin"* ]]; then
                  sed -i '' "s|S3_ENDPOINT=.*|S3_ENDPOINT=http://rustfs:9000|" .env
                  sed -i '' "s|S3_ACCESS_KEY=.*|S3_ACCESS_KEY=$RUSTFS_ACCESS_KEY|" .env
                  sed -i '' "s|S3_SECRET_KEY=.*|S3_SECRET_KEY=$RUSTFS_SECRET_KEY|" .env
                  sed -i '' "s|S3_BUCKET=.*|S3_BUCKET=shellsight-recordings|" .env
              else
                  sed -i "s|S3_ENDPOINT=.*|S3_ENDPOINT=http://rustfs:9000|" .env
                  sed -i "s|S3_ACCESS_KEY=.*|S3_ACCESS_KEY=$RUSTFS_ACCESS_KEY|" .env
                  sed -i "s|S3_SECRET_KEY=.*|S3_SECRET_KEY=$RUSTFS_SECRET_KEY|" .env
                  sed -i "s|S3_BUCKET=.*|S3_BUCKET=shellsight-recordings|" .env
              fi

              if ! grep -q "RUSTFS_ROOT_USER" .env; then
                  cat >> .env << EOF

          # RustFS Configuration (auto-generated)
          RUSTFS_ROOT_USER=$RUSTFS_ADMIN_USER
          RUSTFS_ROOT_PASSWORD=$RUSTFS_ADMIN_PASSWORD
          RUSTFS_ACCESS_KEY=$RUSTFS_ACCESS_KEY
          RUSTFS_SECRET_KEY=$RUSTFS_SECRET_KEY
          EOF
              fi

              echo -e "${GREEN}✓ Configured S3 settings for local RustFS${NC}"

              # Create docker-compose override for RustFS
              cat > docker-compose.rustfs.yml << 'RUSTFS_EOF'
          services:
            rustfs:
              image: minio/minio:latest
              container_name: shellsight-rustfs
              restart: unless-stopped
              ports:
                - "9000:9000"
                - "9001:9001"
              environment:
                - MINIO_ROOT_USER=${RUSTFS_ROOT_USER:-admin}
                - MINIO_ROOT_PASSWORD=${RUSTFS_ROOT_PASSWORD:-changeme}
              volumes:
                - rustfs-data:/data
              command: server /data --console-address ":9001"
              networks:
                - shellsight-network
              healthcheck:
                test: ["CMD", "mc", "ready", "local"]
                interval: 30s
                timeout: 20s
                retries: 3

            rustfs-init:
              image: minio/mc:latest
              container_name: shellsight-rustfs-init
              depends_on:
                rustfs:
                  condition: service_healthy
              environment:
                - MINIO_ROOT_USER=${RUSTFS_ROOT_USER:-admin}
                - MINIO_ROOT_PASSWORD=${RUSTFS_ROOT_PASSWORD:-changeme}
                - ACCESS_KEY=${RUSTFS_ACCESS_KEY:-minioaccess}
                - SECRET_KEY=${RUSTFS_SECRET_KEY:-miniosecret}
              entrypoint: >
                /bin/sh -c "
                mc alias set myminio http://rustfs:9000 \$${MINIO_ROOT_USER} \$${MINIO_ROOT_PASSWORD};
                mc mb myminio/shellsight-recordings --ignore-existing;
                mc admin user add myminio \$${ACCESS_KEY} \$${SECRET_KEY};
                mc admin policy attach myminio readwrite --user \$${ACCESS_KEY};
                echo 'Bucket and user created successfully';
                exit 0;
                "
              networks:
                - shellsight-network

            app:
              depends_on:
                rustfs:
                  condition: service_healthy

          volumes:
            rustfs-data:
          RUSTFS_EOF

              echo -e "${GREEN}✓ Created RustFS docker-compose override${NC}"
          fi

          echo
          echo -e "${GREEN}Pulling and starting containers...${NC}"

          if [ "$INSTALL_RUSTFS" = true ]; then
              $COMPOSE_CMD -f docker-compose.yml -f docker-compose.rustfs.yml pull
              $COMPOSE_CMD -f docker-compose.yml -f docker-compose.rustfs.yml up -d
          else
              $COMPOSE_CMD pull
              $COMPOSE_CMD up -d
          fi

          echo
          echo -e "${GREEN}========================================"
          echo -e "  Deployment Complete!"
          echo -e "========================================${NC}"
          echo
          echo "ShellSight is running at: http://localhost"
          echo

          if [ "$INSTALL_RUSTFS" = true ]; then
              echo -e "${GREEN}========================================"
              echo -e "  RustFS (S3 Storage) Credentials"
              echo -e "========================================${NC}"
              echo
              echo -e "${BLUE}Console URL:${NC}      http://localhost:9001"
              echo -e "${BLUE}Admin Username:${NC}   $RUSTFS_ADMIN_USER"
              echo -e "${BLUE}Admin Password:${NC}   $RUSTFS_ADMIN_PASSWORD"
              echo
              echo -e "${BLUE}S3 Endpoint:${NC}      http://localhost:9000"
              echo -e "${BLUE}Access Key:${NC}       $RUSTFS_ACCESS_KEY"
              echo -e "${BLUE}Secret Key:${NC}       $RUSTFS_SECRET_KEY"
              echo -e "${BLUE}Bucket:${NC}           shellsight-recordings"
              echo
              echo -e "${YELLOW}IMPORTANT: Save these credentials! They are also stored in .env${NC}"
              echo
          fi

          echo "Commands:"
          if [ "$INSTALL_RUSTFS" = true ]; then
              echo "  Logs:    $COMPOSE_CMD -f docker-compose.yml -f docker-compose.rustfs.yml logs -f"
              echo "  Stop:    $COMPOSE_CMD -f docker-compose.yml -f docker-compose.rustfs.yml down"
              echo "  Restart: $COMPOSE_CMD -f docker-compose.yml -f docker-compose.rustfs.yml restart"
          else
              echo "  Logs:    $COMPOSE_CMD logs -f"
              echo "  Stop:    $COMPOSE_CMD down"
              echo "  Restart: $COMPOSE_CMD restart"
          fi
          SCRIPT

          chmod +x release-package/deploy.sh

          # Create tarball
          tar -czvf shellsight-${VERSION}.tar.gz -C release-package .

          # Verify tarball was created
          ls -la shellsight-${VERSION}.tar.gz

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: shellsight-${{ steps.version.outputs.VERSION }}.tar.gz
          body: |
            ## Quick Deployment

            ### Option 1: Download and Deploy

            ```bash
            # Download using GitHub CLI (recommended)
            gh release download ${{ steps.version.outputs.VERSION }} -p "*.tar.gz"

            # Or using curl
            curl -L -o shellsight.tar.gz "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/shellsight-${{ steps.version.outputs.VERSION }}.tar.gz"

            # Extract and deploy
            mkdir shellsight && tar -xzvf shellsight*.tar.gz -C shellsight
            cd shellsight
            ./deploy.sh
            ```

            ### Option 2: Deploy with Built-in S3 Storage (RustFS)

            If you don't have an existing S3 storage, you can install RustFS (MinIO-based S3-compatible storage) alongside ShellSight:

            ```bash
            # Interactive mode (will prompt for RustFS installation)
            ./deploy.sh

            # Or explicitly install RustFS
            ./deploy.sh --with-rustfs

            # With custom admin credentials
            ./deploy.sh --with-rustfs --rustfs-user myadmin --rustfs-password mysecretpass
            ```

            RustFS credentials will be auto-generated and displayed at the end of installation.

            ### Option 3: Docker Pull

            ```bash
            docker pull ghcr.io/${{ github.repository }}:${{ steps.version.outputs.VERSION }}
            ```

            ### Docker Image

            - `ghcr.io/${{ github.repository }}:${{ steps.version.outputs.VERSION }}`
            - `ghcr.io/${{ github.repository }}:latest`

            ### Deploy Script Options

            | Option | Description |
            |--------|-------------|
            | `--with-rustfs` | Install RustFS (S3-compatible storage) alongside ShellSight |
            | `--rustfs-user USER` | Set RustFS admin username (default: admin) |
            | `--rustfs-password PASS` | Set RustFS admin password (default: auto-generated) |
            | `-h, --help` | Show help message |
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
