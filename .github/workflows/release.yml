name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create deployment package
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          REPO: ${{ github.repository }}
        run: |
          mkdir -p release-package/nginx

          # Copy nginx config
          cp nginx/nginx.conf release-package/nginx/

          # Copy env example
          cp .env.example release-package/

          # Create docker-compose.yml
          cat > release-package/docker-compose.yml << EOF
          services:
            app:
              image: ghcr.io/${REPO}:${VERSION}
              container_name: shellsight-app
              restart: unless-stopped
              environment:
                - NODE_ENV=production
                - PORT=3001
                - HOST=0.0.0.0
                - AUTH_DISABLED=\${AUTH_DISABLED:-false}
                - SESSION_SECRET=\${SESSION_SECRET:?SESSION_SECRET is required}
                - JWT_SECRET=\${JWT_SECRET:?JWT_SECRET is required}
                - BASE_URL=\${BASE_URL:-http://localhost}
                - FRONTEND_URL=\${FRONTEND_URL:-http://localhost}
                - S3_BUCKET=\${S3_BUCKET:-shellsight-recordings}
                - S3_REGION=\${S3_REGION:-us-east-1}
                - S3_ENDPOINT=\${S3_ENDPOINT:-}
                - S3_PREFIX=\${S3_PREFIX:-}
                - S3_ACCESS_KEY=\${S3_ACCESS_KEY:-}
                - S3_SECRET_KEY=\${S3_SECRET_KEY:-}
                - DEBUG=\${DEBUG:-false}
                - GOOGLE_CLIENT_ID=\${GOOGLE_CLIENT_ID:-}
                - GOOGLE_CLIENT_SECRET=\${GOOGLE_CLIENT_SECRET:-}
                - GITHUB_CLIENT_ID=\${GITHUB_CLIENT_ID:-}
                - GITHUB_CLIENT_SECRET=\${GITHUB_CLIENT_SECRET:-}
                - MICROSOFT_CLIENT_ID=\${MICROSOFT_CLIENT_ID:-}
                - MICROSOFT_CLIENT_SECRET=\${MICROSOFT_CLIENT_SECRET:-}
                - MICROSOFT_TENANT_ID=\${MICROSOFT_TENANT_ID:-common}
                - OIDC_ISSUER=\${OIDC_ISSUER:-}
                - OIDC_CLIENT_ID=\${OIDC_CLIENT_ID:-}
                - OIDC_CLIENT_SECRET=\${OIDC_CLIENT_SECRET:-}
                - OIDC_DISPLAY_NAME=\${OIDC_DISPLAY_NAME:-SSO}
              networks:
                - shellsight-network
              healthcheck:
                test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:3001/auth/providers',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 10s

            nginx:
              image: nginx:alpine
              container_name: shellsight-nginx
              restart: unless-stopped
              ports:
                - "\${HTTP_PORT:-80}:80"
              volumes:
                - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
              depends_on:
                app:
                  condition: service_healthy
              networks:
                - shellsight-network

          networks:
            shellsight-network:
              driver: bridge
          EOF

          # Create deploy.sh
          cat > release-package/deploy.sh << 'SCRIPT'
          #!/bin/bash
          set -e

          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          NC='\033[0m'

          UNINSTALL=false
          AUTO_YES=false

          while [[ $# -gt 0 ]]; do
              case $1 in
                  --uninstall)
                      UNINSTALL=true
                      shift
                      ;;
                  -y|--yes)
                      AUTO_YES=true
                      shift
                      ;;
                  -h|--help)
                      echo "ShellSight Deployment Script"
                      echo ""
                      echo "Usage: ./deploy.sh [options]"
                      echo ""
                      echo "Options:"
                      echo "  --uninstall            Uninstall ShellSight and all components"
                      echo "  -y, --yes              Auto-answer yes to all prompts (for uninstall)"
                      echo "  -h, --help             Show this help message"
                      echo ""
                      echo "Before running this script, configure your .env file with S3 credentials."
                      echo "For S3-compatible storage like RustFS, use ./deploy-rustfs.sh first."
                      echo ""
                      exit 0
                      ;;
                  *)
                      echo -e "${RED}Unknown option: $1${NC}"
                      echo "Use --help for usage information"
                      exit 1
                      ;;
              esac
          done

          if command -v docker-compose &> /dev/null; then
              COMPOSE_CMD="docker-compose"
          elif docker compose version &> /dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
          else
              echo -e "${RED}Error: Docker Compose is not installed.${NC}"
              exit 1
          fi

          if [ "$UNINSTALL" = true ]; then
              echo -e "${RED}========================================"
              echo -e "  ShellSight Uninstall"
              echo -e "========================================${NC}"
              echo

              echo -e "${YELLOW}This will remove all ShellSight containers and networks.${NC}"
              if [ "$AUTO_YES" = true ]; then
                  confirm="y"
              else
                  read -p "Are you sure you want to continue? [y/N]: " confirm
              fi
              if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
                  echo "Uninstall cancelled."
                  exit 0
              fi

              echo
              echo -e "${BLUE}Stopping and removing containers...${NC}"
              $COMPOSE_CMD down --remove-orphans 2>/dev/null || true
              echo -e "${GREEN}✓ Containers and networks removed${NC}"

              echo
              echo -e "${YELLOW}Do you want to remove Docker volumes (this will delete all data)?${NC}"
              if [ "$AUTO_YES" = true ]; then
                  remove_volumes="y"
              else
                  read -p "Remove volumes? [y/N]: " remove_volumes
              fi
              if [[ "$remove_volumes" =~ ^[Yy]$ ]]; then
                  echo -e "${BLUE}Removing volumes...${NC}"
                  $COMPOSE_CMD down -v 2>/dev/null || true
                  echo -e "${GREEN}✓ Volumes removed${NC}"
              fi

              echo
              echo -e "${YELLOW}Do you want to remove configuration files (.env)?${NC}"
              if [ "$AUTO_YES" = true ]; then
                  remove_config="y"
              else
                  read -p "Remove config files? [y/N]: " remove_config
              fi
              if [[ "$remove_config" =~ ^[Yy]$ ]]; then
                  echo -e "${BLUE}Removing configuration files...${NC}"
                  rm -f .env 2>/dev/null || true
                  echo -e "${GREEN}✓ Configuration files removed${NC}"
              fi

              echo
              echo -e "${GREEN}========================================"
              echo -e "  Uninstall Complete"
              echo -e "========================================${NC}"
              echo
              echo "ShellSight has been uninstalled."
              exit 0
          fi

          echo -e "${GREEN}========================================"
          echo -e "  ShellSight Deployment"
          echo -e "========================================${NC}"
          echo

          if ! command -v docker &> /dev/null; then
              echo -e "${RED}Error: Docker is not installed.${NC}"
              exit 1
          fi

          echo -e "${GREEN}✓ Docker is installed${NC}"
          echo -e "${GREEN}✓ Docker Compose is available ($COMPOSE_CMD)${NC}"
          echo

          if [ ! -f .env ]; then
              echo -e "${YELLOW}Creating .env from template...${NC}"
              cp .env.example .env

              SESSION_SECRET=$(openssl rand -hex 32 2>/dev/null || head -c 64 /dev/urandom | base64 | tr -d '\n' | head -c 64)
              JWT_SECRET=$(openssl rand -hex 32 2>/dev/null || head -c 64 /dev/urandom | base64 | tr -d '\n' | head -c 64)

              if [[ "$OSTYPE" == "darwin"* ]]; then
                  sed -i '' "s/SESSION_SECRET=change-me-to-a-random-string/SESSION_SECRET=$SESSION_SECRET/" .env
                  sed -i '' "s/JWT_SECRET=change-me-to-another-random-string/JWT_SECRET=$JWT_SECRET/" .env
              else
                  sed -i "s/SESSION_SECRET=change-me-to-a-random-string/SESSION_SECRET=$SESSION_SECRET/" .env
                  sed -i "s/JWT_SECRET=change-me-to-another-random-string/JWT_SECRET=$JWT_SECRET/" .env
              fi

              echo -e "${GREEN}✓ Created .env with generated secrets${NC}"
              echo
              echo -e "${YELLOW}IMPORTANT: Configure your S3 settings in .env before continuing.${NC}"
              echo -e "${YELLOW}Required settings: S3_ENDPOINT, S3_ACCESS_KEY, S3_SECRET_KEY, S3_BUCKET${NC}"
              echo
              echo -e "${BLUE}If you need S3-compatible storage, run ./deploy-rustfs.sh first.${NC}"
              echo
              read -p "Press Enter to continue after configuring .env, or Ctrl+C to cancel..."
          fi

          S3_ACCESS_KEY=$(grep "^S3_ACCESS_KEY=" .env | cut -d'=' -f2-)
          S3_SECRET_KEY=$(grep "^S3_SECRET_KEY=" .env | cut -d'=' -f2-)

          if [ -z "$S3_ACCESS_KEY" ] || [ -z "$S3_SECRET_KEY" ]; then
              echo -e "${YELLOW}Warning: S3_ACCESS_KEY or S3_SECRET_KEY is not set in .env${NC}"
              echo -e "${YELLOW}ShellSight requires S3 storage to function properly.${NC}"
              echo
              read -p "Continue anyway? [y/N]: " continue_anyway
              if [[ ! "$continue_anyway" =~ ^[Yy]$ ]]; then
                  echo "Deployment cancelled. Please configure S3 settings in .env"
                  exit 1
              fi
          fi

          echo
          echo -e "${GREEN}Pulling and starting containers...${NC}"
          $COMPOSE_CMD pull
          $COMPOSE_CMD up -d

          echo
          echo -e "${GREEN}========================================"
          echo -e "  Deployment Complete!"
          echo -e "========================================${NC}"
          echo
          echo "ShellSight is running at: http://localhost"
          echo
          echo "Commands:"
          echo "  Logs:    $COMPOSE_CMD logs -f"
          echo "  Stop:    $COMPOSE_CMD down"
          echo "  Restart: $COMPOSE_CMD restart"
          SCRIPT

          chmod +x release-package/deploy.sh

          # Create deploy-rustfs.sh
          cat > release-package/deploy-rustfs.sh << 'RUSTFS_SCRIPT'
          #!/bin/bash
          set -e

          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          NC='\033[0m'

          UNINSTALL=false
          AUTO_YES=false
          CLI_ADMIN_USER=""
          CLI_ADMIN_PASSWORD=""
          CLI_ACCESS_KEY=""
          CLI_SECRET_KEY=""

          while [[ $# -gt 0 ]]; do
              case $1 in
                  --uninstall)
                      UNINSTALL=true
                      shift
                      ;;
                  -y|--yes)
                      AUTO_YES=true
                      shift
                      ;;
                  --admin-user)
                      CLI_ADMIN_USER="$2"
                      shift 2
                      ;;
                  --admin-password)
                      CLI_ADMIN_PASSWORD="$2"
                      shift 2
                      ;;
                  --access-key)
                      CLI_ACCESS_KEY="$2"
                      shift 2
                      ;;
                  --secret-key)
                      CLI_SECRET_KEY="$2"
                      shift 2
                      ;;
                  -h|--help)
                      echo "RustFS Deployment Script"
                      echo ""
                      echo "Usage: ./deploy-rustfs.sh [options]"
                      echo ""
                      echo "Options:"
                      echo "  --uninstall            Uninstall RustFS"
                      echo "  -y, --yes              Auto-answer yes to all prompts"
                      echo "  --admin-user USER      Set admin username (default: admin)"
                      echo "  --admin-password PASS  Set admin password (auto-generated)"
                      echo "  --access-key KEY       Set S3 access key (auto-generated)"
                      echo "  --secret-key SECRET    Set S3 secret key (auto-generated)"
                      echo "  -h, --help             Show this help message"
                      echo ""
                      exit 0
                      ;;
                  *)
                      echo -e "${RED}Unknown option: $1${NC}"
                      exit 1
                      ;;
              esac
          done

          if command -v docker-compose &> /dev/null; then
              COMPOSE_CMD="docker-compose"
          elif docker compose version &> /dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
          else
              echo -e "${RED}Error: Docker Compose is not installed.${NC}"
              exit 1
          fi

          if [ "$UNINSTALL" = true ]; then
              echo -e "${RED}========================================"
              echo -e "  RustFS Uninstall"
              echo -e "========================================${NC}"
              echo

              echo -e "${YELLOW}This will remove RustFS containers.${NC}"
              if [ "$AUTO_YES" = true ]; then
                  confirm="y"
              else
                  read -p "Continue? [y/N]: " confirm
              fi
              if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
                  exit 0
              fi

              if [ -f docker-compose.rustfs.yml ]; then
                  $COMPOSE_CMD -f docker-compose.rustfs.yml down --remove-orphans 2>/dev/null || true
              fi

              echo
              echo -e "${YELLOW}Remove volumes (deletes all data)?${NC}"
              if [ "$AUTO_YES" = true ]; then
                  remove_volumes="y"
              else
                  read -p "Remove volumes? [y/N]: " remove_volumes
              fi
              if [[ "$remove_volumes" =~ ^[Yy]$ ]]; then
                  if [ -f docker-compose.rustfs.yml ]; then
                      $COMPOSE_CMD -f docker-compose.rustfs.yml down -v 2>/dev/null || true
                  fi
                  docker volume rm rustfs-data 2>/dev/null || true
              fi

              echo
              echo -e "${YELLOW}Remove config files?${NC}"
              if [ "$AUTO_YES" = true ]; then
                  remove_config="y"
              else
                  read -p "Remove config? [y/N]: " remove_config
              fi
              if [[ "$remove_config" =~ ^[Yy]$ ]]; then
                  rm -f .env.rustfs docker-compose.rustfs.yml 2>/dev/null || true
              fi

              echo -e "${GREEN}RustFS uninstalled.${NC}"
              exit 0
          fi

          echo -e "${GREEN}========================================"
          echo -e "  RustFS Deployment"
          echo -e "========================================${NC}"
          echo

          if ! command -v docker &> /dev/null; then
              echo -e "${RED}Error: Docker is not installed.${NC}"
              exit 1
          fi

          echo -e "${GREEN}✓ Docker is installed${NC}"
          echo

          # Generate credentials
          RUSTFS_ADMIN_USER="${CLI_ADMIN_USER:-admin}"
          if [ -n "$CLI_ADMIN_PASSWORD" ]; then
              RUSTFS_ADMIN_PASSWORD="$CLI_ADMIN_PASSWORD"
          else
              RUSTFS_ADMIN_PASSWORD=$(openssl rand -base64 16 2>/dev/null | tr -d '/+=' | head -c 16)
          fi

          if [ -n "$CLI_ACCESS_KEY" ]; then
              S3_ACCESS_KEY="$CLI_ACCESS_KEY"
          else
              S3_ACCESS_KEY=$(openssl rand -hex 10 2>/dev/null)
          fi

          if [ -n "$CLI_SECRET_KEY" ]; then
              S3_SECRET_KEY="$CLI_SECRET_KEY"
          else
              S3_SECRET_KEY=$(openssl rand -base64 32 2>/dev/null | tr -d '/+=' | head -c 40)
          fi

          cat > .env.rustfs << EOF
          RUSTFS_ADMIN_USER=$RUSTFS_ADMIN_USER
          RUSTFS_ADMIN_PASSWORD=$RUSTFS_ADMIN_PASSWORD
          S3_ACCESS_KEY=$S3_ACCESS_KEY
          S3_SECRET_KEY=$S3_SECRET_KEY
          EOF

          cat > docker-compose.rustfs.yml << 'EOF'
          services:
            rustfs:
              image: rustfs/rustfs:latest
              container_name: rustfs
              restart: unless-stopped
              ports:
                - "9000:9000"
                - "9001:9001"
              environment:
                RUSTFS_ACCESS_KEY: ${RUSTFS_ADMIN_USER:-admin}
                RUSTFS_SECRET_KEY: ${RUSTFS_ADMIN_PASSWORD:-changeme}
                RUSTFS_CONSOLE_ENABLE: "true"
              volumes:
                - rustfs-data:/data
              healthcheck:
                test: ["CMD-SHELL", "nc -z localhost 9000 || exit 1"]
                interval: 10s
                timeout: 5s
                retries: 10
                start_period: 10s

            rustfs-init:
              image: minio/mc:latest
              container_name: rustfs-init
              depends_on:
                rustfs:
                  condition: service_healthy
              environment:
                RUSTFS_ADMIN_USER: ${RUSTFS_ADMIN_USER:-admin}
                RUSTFS_ADMIN_PASSWORD: ${RUSTFS_ADMIN_PASSWORD:-changeme}
                S3_ACCESS_KEY: ${S3_ACCESS_KEY}
                S3_SECRET_KEY: ${S3_SECRET_KEY}
              entrypoint: ["/bin/sh", "-c"]
              command:
                - |
                  mc alias set rustfs http://rustfs:9000 $${RUSTFS_ADMIN_USER} $${RUSTFS_ADMIN_PASSWORD}
                  mc mb rustfs/shellsight-recordings --ignore-existing
                  mc admin user add rustfs $${S3_ACCESS_KEY} $${S3_SECRET_KEY} || true
                  mc admin policy attach rustfs readwrite --user $${S3_ACCESS_KEY} || true
                  echo 'Bucket and user created'

          volumes:
            rustfs-data:
          EOF

          echo -e "${GREEN}Starting RustFS...${NC}"
          $COMPOSE_CMD -f docker-compose.rustfs.yml --env-file .env.rustfs up -d

          sleep 5

          echo
          echo -e "${GREEN}========================================"
          echo -e "  RustFS Deployed!"
          echo -e "========================================${NC}"
          echo
          echo -e "${BLUE}Console:${NC}    http://localhost:9001"
          echo -e "${BLUE}Admin:${NC}      $RUSTFS_ADMIN_USER / $RUSTFS_ADMIN_PASSWORD"
          echo
          echo -e "${GREEN}S3 Credentials for ShellSight:${NC}"
          echo -e "${BLUE}Endpoint:${NC}   http://localhost:9000"
          echo -e "${BLUE}Access Key:${NC} $S3_ACCESS_KEY"
          echo -e "${BLUE}Secret Key:${NC} $S3_SECRET_KEY"
          echo -e "${BLUE}Bucket:${NC}     shellsight-recordings"
          echo
          echo -e "${YELLOW}Credentials saved to .env.rustfs${NC}"
          RUSTFS_SCRIPT

          chmod +x release-package/deploy-rustfs.sh

          # Create tarball
          tar -czvf shellsight-${VERSION}.tar.gz -C release-package .

          # Verify tarball was created
          ls -la shellsight-${VERSION}.tar.gz

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: shellsight-${{ steps.version.outputs.VERSION }}.tar.gz
          body: |
            ## Quick Deployment

            ### Option 1: With Existing S3 Storage

            ```bash
            # Download and extract
            curl -L -o shellsight.tar.gz "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/shellsight-${{ steps.version.outputs.VERSION }}.tar.gz"
            mkdir shellsight && tar -xzvf shellsight.tar.gz -C shellsight
            cd shellsight

            # Configure S3 settings in .env, then deploy
            ./deploy.sh
            ```

            ### Option 2: With RustFS (S3-compatible storage)

            If you don't have S3 storage, deploy [RustFS](https://rustfs.com/) first:

            ```bash
            # Deploy RustFS (generates admin + S3 credentials)
            ./deploy-rustfs.sh

            # Copy the S3 credentials to ShellSight .env, then deploy
            ./deploy.sh
            ```

            ### Option 3: Docker Pull

            ```bash
            docker pull ghcr.io/${{ github.repository }}:${{ steps.version.outputs.VERSION }}
            ```

            ### Docker Images

            - `ghcr.io/${{ github.repository }}:${{ steps.version.outputs.VERSION }}`
            - `ghcr.io/${{ github.repository }}:latest`

            ### Deploy Scripts

            **deploy.sh** - Deploy ShellSight

            | Option | Description |
            |--------|-------------|
            | `--uninstall` | Uninstall ShellSight |
            | `-y, --yes` | Auto-answer yes to prompts |
            | `-h, --help` | Show help |

            **deploy-rustfs.sh** - Deploy RustFS (S3-compatible storage)

            | Option | Description |
            |--------|-------------|
            | `--uninstall` | Uninstall RustFS |
            | `-y, --yes` | Auto-answer yes to prompts |
            | `--admin-user USER` | Set admin username (default: admin) |
            | `--admin-password PASS` | Set admin password (auto-generated) |
            | `--access-key KEY` | Set S3 access key (auto-generated) |
            | `--secret-key SECRET` | Set S3 secret key (auto-generated) |
            | `-h, --help` | Show help |

            ### Uninstalling

            ```bash
            # Uninstall ShellSight
            ./deploy.sh --uninstall

            # Uninstall RustFS (if deployed)
            ./deploy-rustfs.sh --uninstall
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
