name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create deployment package
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          REPO: ${{ github.repository }}
        run: |
          mkdir -p release-package/nginx

          # Copy nginx config
          cp nginx/nginx.conf release-package/nginx/

          # Copy env example
          cp .env.example release-package/

          # Create docker-compose.yml
          cat > release-package/docker-compose.yml << EOF
          services:
            app:
              image: ghcr.io/${REPO}:${VERSION}
              container_name: shellsight-app
              restart: unless-stopped
              environment:
                - NODE_ENV=production
                - PORT=3001
                - HOST=0.0.0.0
                - AUTH_DISABLED=\${AUTH_DISABLED:-false}
                - SESSION_SECRET=\${SESSION_SECRET:?SESSION_SECRET is required}
                - JWT_SECRET=\${JWT_SECRET:?JWT_SECRET is required}
                - BASE_URL=\${BASE_URL:-http://localhost}
                - FRONTEND_URL=\${FRONTEND_URL:-http://localhost}
                - S3_BUCKET=\${S3_BUCKET:-shellsight-recordings}
                - S3_REGION=\${S3_REGION:-us-east-1}
                - S3_ENDPOINT=\${S3_ENDPOINT:-}
                - S3_PREFIX=\${S3_PREFIX:-}
                - S3_ACCESS_KEY=\${S3_ACCESS_KEY:-}
                - S3_SECRET_KEY=\${S3_SECRET_KEY:-}
                - DEBUG=\${DEBUG:-false}
                - GOOGLE_CLIENT_ID=\${GOOGLE_CLIENT_ID:-}
                - GOOGLE_CLIENT_SECRET=\${GOOGLE_CLIENT_SECRET:-}
                - GITHUB_CLIENT_ID=\${GITHUB_CLIENT_ID:-}
                - GITHUB_CLIENT_SECRET=\${GITHUB_CLIENT_SECRET:-}
                - MICROSOFT_CLIENT_ID=\${MICROSOFT_CLIENT_ID:-}
                - MICROSOFT_CLIENT_SECRET=\${MICROSOFT_CLIENT_SECRET:-}
                - MICROSOFT_TENANT_ID=\${MICROSOFT_TENANT_ID:-common}
                - OIDC_ISSUER=\${OIDC_ISSUER:-}
                - OIDC_CLIENT_ID=\${OIDC_CLIENT_ID:-}
                - OIDC_CLIENT_SECRET=\${OIDC_CLIENT_SECRET:-}
                - OIDC_DISPLAY_NAME=\${OIDC_DISPLAY_NAME:-SSO}
              networks:
                - shellsight-network
              healthcheck:
                test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:3001/auth/providers',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 10s

            nginx:
              image: nginx:alpine
              container_name: shellsight-nginx
              restart: unless-stopped
              ports:
                - "\${HTTP_PORT:-80}:80"
              volumes:
                - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
              depends_on:
                app:
                  condition: service_healthy
              networks:
                - shellsight-network

          networks:
            shellsight-network:
              driver: bridge
          EOF

          # Create deploy.sh
          cat > release-package/deploy.sh << 'SCRIPT'
          #!/bin/bash
          set -e

          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          NC='\033[0m'

          # Default values
          INSTALL_RUSTFS=false
          UNINSTALL=false
          AUTO_YES=false
          CLI_ADMIN_USER=""
          CLI_ADMIN_PASSWORD=""

          # Parse command line arguments
          while [[ $# -gt 0 ]]; do
              case $1 in
                  --with-rustfs)
                      INSTALL_RUSTFS=true
                      shift
                      ;;
                  --uninstall)
                      UNINSTALL=true
                      shift
                      ;;
                  -y|--yes)
                      AUTO_YES=true
                      shift
                      ;;
                  --admin-user)
                      CLI_ADMIN_USER="$2"
                      shift 2
                      ;;
                  --admin-password)
                      CLI_ADMIN_PASSWORD="$2"
                      shift 2
                      ;;
                  -h|--help)
                      echo "ShellSight Deployment Script"
                      echo ""
                      echo "Usage: ./deploy.sh [options]"
                      echo ""
                      echo "Options:"
                      echo "  --with-rustfs          Install RustFS (S3-compatible storage) alongside ShellSight"
                      echo "  --uninstall            Uninstall ShellSight and all components"
                      echo "  -y, --yes              Auto-answer yes to all prompts (for uninstall)"
                      echo "  --admin-user USER      Set RustFS admin username (default: admin)"
                      echo "  --admin-password PASS  Set RustFS admin password (auto-generated if not provided)"
                      echo "  -h, --help             Show this help message"
                      echo ""
                      echo "RustFS credentials are auto-generated during installation unless specified via CLI."
                      echo ""
                      exit 0
                      ;;
                  *)
                      echo -e "${RED}Unknown option: $1${NC}"
                      echo "Use --help for usage information"
                      exit 1
                      ;;
              esac
          done

          # Handle uninstall
          if [ "$UNINSTALL" = true ]; then
              echo -e "${RED}========================================"
              echo -e "  ShellSight Uninstall"
              echo -e "========================================${NC}"
              echo

              if command -v docker-compose &> /dev/null; then
                  COMPOSE_CMD="docker-compose"
              elif docker compose version &> /dev/null 2>&1; then
                  COMPOSE_CMD="docker compose"
              else
                  echo -e "${RED}Error: Docker Compose is not installed.${NC}"
                  exit 1
              fi

              echo -e "${YELLOW}This will remove all ShellSight containers and networks.${NC}"
              if [ "$AUTO_YES" = true ]; then
                  confirm="y"
              else
                  read -p "Are you sure you want to continue? [y/N]: " confirm
              fi
              if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
                  echo "Uninstall cancelled."
                  exit 0
              fi

              echo
              echo -e "${BLUE}Stopping and removing containers...${NC}"

              if [ -f docker-compose.rustfs.yml ]; then
                  $COMPOSE_CMD -f docker-compose.yml -f docker-compose.rustfs.yml down --remove-orphans 2>/dev/null || true
              else
                  $COMPOSE_CMD down --remove-orphans 2>/dev/null || true
              fi

              echo -e "${GREEN}✓ Containers and networks removed${NC}"

              echo
              echo -e "${YELLOW}Do you want to remove Docker volumes (this will delete all data)?${NC}"
              if [ "$AUTO_YES" = true ]; then
                  remove_volumes="y"
              else
                  read -p "Remove volumes? [y/N]: " remove_volumes
              fi
              if [[ "$remove_volumes" =~ ^[Yy]$ ]]; then
                  echo -e "${BLUE}Removing volumes...${NC}"
                  if [ -f docker-compose.rustfs.yml ]; then
                      $COMPOSE_CMD -f docker-compose.yml -f docker-compose.rustfs.yml down -v 2>/dev/null || true
                  else
                      $COMPOSE_CMD down -v 2>/dev/null || true
                  fi
                  docker volume rm shellsight_rustfs-data shellsight_rustfs-logs 2>/dev/null || true
                  docker volume rm rustfs-data rustfs-logs 2>/dev/null || true
                  echo -e "${GREEN}✓ Volumes removed${NC}"
              fi

              echo
              echo -e "${YELLOW}Do you want to remove configuration files (.env, docker-compose.rustfs.yml)?${NC}"
              if [ "$AUTO_YES" = true ]; then
                  remove_config="y"
              else
                  read -p "Remove config files? [y/N]: " remove_config
              fi
              if [[ "$remove_config" =~ ^[Yy]$ ]]; then
                  echo -e "${BLUE}Removing configuration files...${NC}"
                  rm -f .env docker-compose.rustfs.yml 2>/dev/null || true
                  echo -e "${GREEN}✓ Configuration files removed${NC}"
              fi

              echo
              echo -e "${GREEN}========================================"
              echo -e "  Uninstall Complete"
              echo -e "========================================${NC}"
              echo
              echo "ShellSight has been uninstalled."
              exit 0
          fi

          echo -e "${GREEN}========================================"
          echo -e "  ShellSight Deployment"
          echo -e "========================================${NC}"
          echo

          if ! command -v docker &> /dev/null; then
              echo -e "${RED}Error: Docker is not installed.${NC}"
              exit 1
          fi

          if command -v docker-compose &> /dev/null; then
              COMPOSE_CMD="docker-compose"
          elif docker compose version &> /dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
          else
              echo -e "${RED}Error: Docker Compose is not installed.${NC}"
              exit 1
          fi

          echo -e "${GREEN}✓ Docker is installed${NC}"
          echo -e "${GREEN}✓ Docker Compose is available ($COMPOSE_CMD)${NC}"
          echo

          # Ask about RustFS installation if not specified via command line
          if [ "$INSTALL_RUSTFS" = false ]; then
              echo -e "${YELLOW}Do you want to install RustFS (S3-compatible storage) on this VM?${NC}"
              echo "This is useful if you don't have an existing S3 storage."
              read -p "Install RustFS? [y/N]: " install_rustfs_answer
              if [[ "$install_rustfs_answer" =~ ^[Yy]$ ]]; then
                  INSTALL_RUSTFS=true
              fi
          fi

          # Generate RustFS credentials if installing
          if [ "$INSTALL_RUSTFS" = true ]; then
              echo
              echo -e "${BLUE}Setting up RustFS...${NC}"

              # Use CLI admin credentials if provided, otherwise generate/use defaults
              if [ -n "$CLI_ADMIN_USER" ]; then
                  RUSTFS_ADMIN_USER="$CLI_ADMIN_USER"
              else
                  RUSTFS_ADMIN_USER="admin"
              fi

              if [ -n "$CLI_ADMIN_PASSWORD" ]; then
                  RUSTFS_ADMIN_PASSWORD="$CLI_ADMIN_PASSWORD"
              elif [ -z "$RUSTFS_ADMIN_PASSWORD" ]; then
                  RUSTFS_ADMIN_PASSWORD=$(openssl rand -base64 16 2>/dev/null | tr -d '/+=' | head -c 16)
                  if [ -z "$RUSTFS_ADMIN_PASSWORD" ]; then
                      RUSTFS_ADMIN_PASSWORD=$(head -c 32 /dev/urandom | base64 | tr -d '/+=' | head -c 16)
                  fi
              fi

              # Use admin credentials for S3 access (simpler and more reliable)
              S3_APP_ACCESS_KEY="$RUSTFS_ADMIN_USER"
              S3_APP_SECRET_KEY="$RUSTFS_ADMIN_PASSWORD"

              echo -e "${GREEN}✓ RustFS admin credentials configured${NC}"
          fi

          if [ ! -f .env ]; then
              echo -e "${YELLOW}Creating .env from template...${NC}"
              cp .env.example .env

              SESSION_SECRET=$(openssl rand -hex 32 2>/dev/null || head -c 64 /dev/urandom | base64 | tr -d '\n' | head -c 64)
              JWT_SECRET=$(openssl rand -hex 32 2>/dev/null || head -c 64 /dev/urandom | base64 | tr -d '\n' | head -c 64)

              if [[ "$OSTYPE" == "darwin"* ]]; then
                  sed -i '' "s/SESSION_SECRET=change-me-to-a-random-string/SESSION_SECRET=$SESSION_SECRET/" .env
                  sed -i '' "s/JWT_SECRET=change-me-to-another-random-string/JWT_SECRET=$JWT_SECRET/" .env
              else
                  sed -i "s/SESSION_SECRET=change-me-to-a-random-string/SESSION_SECRET=$SESSION_SECRET/" .env
                  sed -i "s/JWT_SECRET=change-me-to-another-random-string/JWT_SECRET=$JWT_SECRET/" .env
              fi

              echo -e "${GREEN}✓ Created .env with generated secrets${NC}"
          fi

          # Configure RustFS in .env if installing
          if [ "$INSTALL_RUSTFS" = true ]; then
              # Check current S3 settings
              CURRENT_S3_ACCESS_KEY=$(grep "^S3_ACCESS_KEY=" .env | cut -d'=' -f2-)

              echo -e "${BLUE}Configuring S3 settings for local RustFS...${NC}"
              if [[ "$OSTYPE" == "darwin"* ]]; then
                  sed -i '' "s|S3_ENDPOINT=.*|S3_ENDPOINT=http://rustfs:9000|" .env
                  sed -i '' "s|S3_BUCKET=.*|S3_BUCKET=shellsight-recordings|" .env
              else
                  sed -i "s|S3_ENDPOINT=.*|S3_ENDPOINT=http://rustfs:9000|" .env
                  sed -i "s|S3_BUCKET=.*|S3_BUCKET=shellsight-recordings|" .env
              fi

              # Set S3 credentials if not already configured
              if [ -z "$CURRENT_S3_ACCESS_KEY" ]; then
                  if [[ "$OSTYPE" == "darwin"* ]]; then
                      sed -i '' "s|S3_ACCESS_KEY=.*|S3_ACCESS_KEY=$S3_APP_ACCESS_KEY|" .env
                      sed -i '' "s|S3_SECRET_KEY=.*|S3_SECRET_KEY=$S3_APP_SECRET_KEY|" .env
                  else
                      sed -i "s|S3_ACCESS_KEY=.*|S3_ACCESS_KEY=$S3_APP_ACCESS_KEY|" .env
                      sed -i "s|S3_SECRET_KEY=.*|S3_SECRET_KEY=$S3_APP_SECRET_KEY|" .env
                  fi
                  echo -e "${GREEN}✓ Configured S3 endpoint and credentials for local RustFS${NC}"
              else
                  echo -e "${GREEN}✓ Configured S3 endpoint for local RustFS${NC}"
                  echo -e "${YELLOW}  S3 credentials already set, keeping existing values${NC}"
              fi

              if ! grep -q "RUSTFS_ADMIN_USER" .env; then
                  cat >> .env << EOF

          # RustFS Configuration (auto-generated)
          RUSTFS_ADMIN_USER=$RUSTFS_ADMIN_USER
          RUSTFS_ADMIN_PASSWORD=$RUSTFS_ADMIN_PASSWORD
          EOF
              fi

              # Create docker-compose override for RustFS
              cat > docker-compose.rustfs.yml << 'RUSTFS_EOF'
          services:
            rustfs:
              image: rustfs/rustfs:latest
              container_name: shellsight-rustfs
              restart: unless-stopped
              ports:
                - "9000:9000"
                - "9001:9001"
              environment:
                RUSTFS_ACCESS_KEY: ${RUSTFS_ADMIN_USER:-admin}
                RUSTFS_SECRET_KEY: ${RUSTFS_ADMIN_PASSWORD:-changeme}
                RUSTFS_CONSOLE_ENABLE: "true"
              volumes:
                - rustfs-data:/data
              networks:
                - shellsight-network
              healthcheck:
                test: ["CMD-SHELL", "nc -z localhost 9000 || exit 1"]
                interval: 10s
                timeout: 5s
                retries: 10
                start_period: 10s

            # Init container to create bucket
            rustfs-init:
              image: minio/mc:latest
              container_name: shellsight-rustfs-init
              depends_on:
                rustfs:
                  condition: service_healthy
              environment:
                RUSTFS_ADMIN_USER: ${RUSTFS_ADMIN_USER:-admin}
                RUSTFS_ADMIN_PASSWORD: ${RUSTFS_ADMIN_PASSWORD:-changeme}
              entrypoint: ["/bin/sh", "-c"]
              command:
                - |
                  # Connect with admin credentials
                  mc alias set rustfs http://rustfs:9000 $${RUSTFS_ADMIN_USER} $${RUSTFS_ADMIN_PASSWORD}

                  # Create bucket
                  mc mb rustfs/shellsight-recordings --ignore-existing

                  echo 'Bucket created successfully'
              networks:
                - shellsight-network

            app:
              depends_on:
                rustfs:
                  condition: service_healthy

          volumes:
            rustfs-data:
          RUSTFS_EOF

              echo -e "${GREEN}✓ Created RustFS docker-compose override${NC}"
          fi

          echo
          echo -e "${GREEN}Pulling and starting containers...${NC}"

          if [ "$INSTALL_RUSTFS" = true ]; then
              $COMPOSE_CMD -f docker-compose.yml -f docker-compose.rustfs.yml pull
              $COMPOSE_CMD -f docker-compose.yml -f docker-compose.rustfs.yml up -d
          else
              $COMPOSE_CMD pull
              $COMPOSE_CMD up -d
          fi

          echo
          echo -e "${GREEN}========================================"
          echo -e "  Deployment Complete!"
          echo -e "========================================${NC}"
          echo
          echo "ShellSight is running at: http://localhost"
          echo

          if [ "$INSTALL_RUSTFS" = true ]; then
              echo -e "${GREEN}========================================"
              echo -e "  RustFS Admin Credentials"
              echo -e "========================================${NC}"
              echo
              echo -e "${BLUE}Console URL:${NC}      http://localhost:9001"
              echo -e "${BLUE}Admin Username:${NC}   $RUSTFS_ADMIN_USER"
              echo -e "${BLUE}Admin Password:${NC}   $RUSTFS_ADMIN_PASSWORD"
              echo
              echo -e "${GREEN}========================================"
              echo -e "  S3 Credentials"
              echo -e "========================================${NC}"
              echo
              echo -e "${BLUE}S3 Endpoint:${NC}      http://localhost:9000"
              echo -e "${BLUE}Access Key:${NC}       $RUSTFS_ADMIN_USER"
              echo -e "${BLUE}Secret Key:${NC}       $RUSTFS_ADMIN_PASSWORD"
              echo -e "${BLUE}Bucket:${NC}           shellsight-recordings"
              echo
              echo -e "${YELLOW}IMPORTANT: Save these credentials! They are also stored in .env${NC}"
              echo
          fi

          echo "Commands:"
          if [ "$INSTALL_RUSTFS" = true ]; then
              echo "  Logs:    $COMPOSE_CMD -f docker-compose.yml -f docker-compose.rustfs.yml logs -f"
              echo "  Stop:    $COMPOSE_CMD -f docker-compose.yml -f docker-compose.rustfs.yml down"
              echo "  Restart: $COMPOSE_CMD -f docker-compose.yml -f docker-compose.rustfs.yml restart"
          else
              echo "  Logs:    $COMPOSE_CMD logs -f"
              echo "  Stop:    $COMPOSE_CMD down"
              echo "  Restart: $COMPOSE_CMD restart"
          fi
          SCRIPT

          chmod +x release-package/deploy.sh

          # Create tarball
          tar -czvf shellsight-${VERSION}.tar.gz -C release-package .

          # Verify tarball was created
          ls -la shellsight-${VERSION}.tar.gz

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: shellsight-${{ steps.version.outputs.VERSION }}.tar.gz
          body: |
            ## Quick Deployment

            ### Option 1: Download and Deploy

            ```bash
            # Download using GitHub CLI (recommended)
            gh release download ${{ steps.version.outputs.VERSION }} -p "*.tar.gz"

            # Or using curl
            curl -L -o shellsight.tar.gz "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/shellsight-${{ steps.version.outputs.VERSION }}.tar.gz"

            # Extract and deploy
            mkdir shellsight && tar -xzvf shellsight*.tar.gz -C shellsight
            cd shellsight
            ./deploy.sh
            ```

            ### Option 2: Deploy with Built-in S3 Storage (RustFS)

            If you don't have an existing S3 storage, you can install [RustFS](https://rustfs.com/) (high-performance S3-compatible storage) alongside ShellSight:

            ```bash
            # Interactive mode (will prompt for RustFS installation)
            ./deploy.sh

            # Or explicitly install RustFS
            ./deploy.sh --with-rustfs
            ```

            Admin credentials are auto-generated and used for both:
            - **RustFS console login**: http://localhost:9001
            - **S3 access**: For ShellSight to store recordings

            ### Option 3: Docker Pull

            ```bash
            docker pull ghcr.io/${{ github.repository }}:${{ steps.version.outputs.VERSION }}
            ```

            ### Docker Image

            - `ghcr.io/${{ github.repository }}:${{ steps.version.outputs.VERSION }}`
            - `ghcr.io/${{ github.repository }}:latest`

            ### Deploy Script Options

            | Option | Description |
            |--------|-------------|
            | `--with-rustfs` | Install RustFS (S3-compatible storage) alongside ShellSight |
            | `--uninstall` | Uninstall ShellSight and all components |
            | `-y, --yes` | Auto-answer yes to all prompts (for uninstall) |
            | `--admin-user USER` | Set RustFS admin username (default: admin) |
            | `--admin-password PASS` | Set RustFS admin password (auto-generated if not provided) |
            | `-h, --help` | Show help message |

            RustFS credentials (auto-generated unless specified via CLI):
            - **Admin user**: For console login and S3 access (username: `admin`, password: auto-generated)

            ### Uninstalling

            To completely remove ShellSight:

            ```bash
            ./deploy.sh --uninstall
            ```

            This will prompt you to:
            1. Remove containers and networks
            2. Optionally remove Docker volumes (deletes all data)
            3. Optionally remove configuration files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
