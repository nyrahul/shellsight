name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create deployment package
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          REPO: ${{ github.repository }}
        run: |
          mkdir -p release-package/nginx

          # Copy nginx config
          cp nginx/nginx.conf release-package/nginx/

          # Copy env example
          cp .env.example release-package/

          # Create docker-compose.yml
          cat > release-package/docker-compose.yml << EOF
          services:
            app:
              image: ghcr.io/${REPO}:${VERSION}
              container_name: shellsight-app
              restart: unless-stopped
              environment:
                - NODE_ENV=production
                - PORT=3001
                - HOST=0.0.0.0
                - AUTH_DISABLED=\${AUTH_DISABLED:-false}
                - SESSION_SECRET=\${SESSION_SECRET:?SESSION_SECRET is required}
                - JWT_SECRET=\${JWT_SECRET:?JWT_SECRET is required}
                - BASE_URL=\${BASE_URL:-http://localhost}
                - FRONTEND_URL=\${FRONTEND_URL:-http://localhost}
                - S3_BUCKET=\${S3_BUCKET:-shellsight-recordings}
                - S3_REGION=\${S3_REGION:-us-east-1}
                - S3_ENDPOINT=\${S3_ENDPOINT:-}
                - S3_PREFIX=\${S3_PREFIX:-}
                - S3_ACCESS_KEY=\${S3_ACCESS_KEY:-}
                - S3_SECRET_KEY=\${S3_SECRET_KEY:-}
                - DEBUG=\${DEBUG:-false}
                - GOOGLE_CLIENT_ID=\${GOOGLE_CLIENT_ID:-}
                - GOOGLE_CLIENT_SECRET=\${GOOGLE_CLIENT_SECRET:-}
                - GITHUB_CLIENT_ID=\${GITHUB_CLIENT_ID:-}
                - GITHUB_CLIENT_SECRET=\${GITHUB_CLIENT_SECRET:-}
                - MICROSOFT_CLIENT_ID=\${MICROSOFT_CLIENT_ID:-}
                - MICROSOFT_CLIENT_SECRET=\${MICROSOFT_CLIENT_SECRET:-}
                - MICROSOFT_TENANT_ID=\${MICROSOFT_TENANT_ID:-common}
                - OIDC_ISSUER=\${OIDC_ISSUER:-}
                - OIDC_CLIENT_ID=\${OIDC_CLIENT_ID:-}
                - OIDC_CLIENT_SECRET=\${OIDC_CLIENT_SECRET:-}
                - OIDC_DISPLAY_NAME=\${OIDC_DISPLAY_NAME:-SSO}
              networks:
                - shellsight-network
              healthcheck:
                test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:3001/auth/providers',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 10s

            nginx:
              image: nginx:alpine
              container_name: shellsight-nginx
              restart: unless-stopped
              ports:
                - "\${HTTP_PORT:-80}:80"
              volumes:
                - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
              depends_on:
                app:
                  condition: service_healthy
              networks:
                - shellsight-network

          networks:
            shellsight-network:
              driver: bridge
          EOF

          # Create deploy.sh
          cat > release-package/deploy.sh << 'SCRIPT'
          #!/bin/bash
          set -e

          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          NC='\033[0m'

          echo -e "${GREEN}========================================"
          echo -e "  ShellSight Deployment"
          echo -e "========================================${NC}"
          echo

          if ! command -v docker &> /dev/null; then
              echo -e "${RED}Error: Docker is not installed.${NC}"
              exit 1
          fi

          if command -v docker-compose &> /dev/null; then
              COMPOSE_CMD="docker-compose"
          elif docker compose version &> /dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
          else
              echo -e "${RED}Error: Docker Compose is not installed.${NC}"
              exit 1
          fi

          echo -e "${GREEN}✓ Docker is installed${NC}"
          echo -e "${GREEN}✓ Docker Compose is available${NC}"
          echo

          if [ ! -f .env ]; then
              echo -e "${YELLOW}Creating .env from template...${NC}"
              cp .env.example .env

              SESSION_SECRET=$(openssl rand -hex 32 2>/dev/null || head -c 64 /dev/urandom | base64 | tr -d '\n' | head -c 64)
              JWT_SECRET=$(openssl rand -hex 32 2>/dev/null || head -c 64 /dev/urandom | base64 | tr -d '\n' | head -c 64)

              if [[ "$OSTYPE" == "darwin"* ]]; then
                  sed -i '' "s/SESSION_SECRET=change-me-to-a-random-string/SESSION_SECRET=$SESSION_SECRET/" .env
                  sed -i '' "s/JWT_SECRET=change-me-to-another-random-string/JWT_SECRET=$JWT_SECRET/" .env
              else
                  sed -i "s/SESSION_SECRET=change-me-to-a-random-string/SESSION_SECRET=$SESSION_SECRET/" .env
                  sed -i "s/JWT_SECRET=change-me-to-another-random-string/JWT_SECRET=$JWT_SECRET/" .env
              fi

              echo -e "${GREEN}✓ Created .env with generated secrets${NC}"
              echo
              echo -e "${YELLOW}Please edit .env to configure S3 storage and authentication${NC}"
              read -p "Press Enter to continue after editing .env..."
          fi

          echo
          echo -e "${GREEN}Pulling and starting containers...${NC}"
          $COMPOSE_CMD pull
          $COMPOSE_CMD up -d

          echo
          echo -e "${GREEN}========================================"
          echo -e "  Deployment Complete!"
          echo -e "========================================${NC}"
          echo
          echo "ShellSight is running at: http://localhost"
          echo
          echo "Commands:"
          echo "  Logs:    $COMPOSE_CMD logs -f"
          echo "  Stop:    $COMPOSE_CMD down"
          echo "  Restart: $COMPOSE_CMD restart"
          SCRIPT

          chmod +x release-package/deploy.sh

          # Create tarball
          tar -czvf shellsight-${VERSION}.tar.gz -C release-package .

          # Verify tarball was created
          ls -la shellsight-${VERSION}.tar.gz

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: shellsight-${{ steps.version.outputs.VERSION }}.tar.gz
          body: |
            ## Quick Deployment

            ### Option 1: Download and Deploy

            ```bash
            # Download using GitHub CLI (recommended)
            gh release download ${{ steps.version.outputs.VERSION }} -p "*.tar.gz"

            # Or using curl
            curl -L -o shellsight.tar.gz "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/shellsight-${{ steps.version.outputs.VERSION }}.tar.gz"

            # Extract and deploy
            mkdir shellsight && tar -xzvf shellsight*.tar.gz -C shellsight
            cd shellsight
            ./deploy.sh
            ```

            ### Option 2: Docker Pull

            ```bash
            docker pull ghcr.io/${{ github.repository }}:${{ steps.version.outputs.VERSION }}
            ```

            ### Docker Image

            - `ghcr.io/${{ github.repository }}:${{ steps.version.outputs.VERSION }}`
            - `ghcr.io/${{ github.repository }}:latest`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
