name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create deployment package
        run: |
          mkdir -p release-package

          # Copy deployment files
          cp docker-compose.yml release-package/
          cp .env.example release-package/
          cp deploy.sh release-package/
          cp -r nginx release-package/

          # Create docker-compose for pre-built image
          cat > release-package/docker-compose.yml << 'EOF'
          services:
            app:
              image: ghcr.io/${{ github.repository }}:${{ steps.version.outputs.VERSION }}
              container_name: shellsight-app
              restart: unless-stopped
              environment:
                - NODE_ENV=production
                - PORT=3001
                - HOST=0.0.0.0
                - AUTH_DISABLED=${AUTH_DISABLED:-false}
                - SESSION_SECRET=${SESSION_SECRET:?SESSION_SECRET is required}
                - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
                - BASE_URL=${BASE_URL:-http://localhost}
                - FRONTEND_URL=${FRONTEND_URL:-http://localhost}
                - S3_BUCKET=${S3_BUCKET:-shellsight-recordings}
                - S3_REGION=${S3_REGION:-us-east-1}
                - S3_ENDPOINT=${S3_ENDPOINT:-}
                - S3_PREFIX=${S3_PREFIX:-}
                - S3_ACCESS_KEY=${S3_ACCESS_KEY:-}
                - S3_SECRET_KEY=${S3_SECRET_KEY:-}
                - DEBUG=${DEBUG:-false}
                - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
                - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
                - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
                - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
                - MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID:-}
                - MICROSOFT_CLIENT_SECRET=${MICROSOFT_CLIENT_SECRET:-}
                - MICROSOFT_TENANT_ID=${MICROSOFT_TENANT_ID:-common}
                - OIDC_ISSUER=${OIDC_ISSUER:-}
                - OIDC_CLIENT_ID=${OIDC_CLIENT_ID:-}
                - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET:-}
                - OIDC_DISPLAY_NAME=${OIDC_DISPLAY_NAME:-SSO}
              networks:
                - shellsight-network
              healthcheck:
                test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:3001/auth/providers',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 10s

            nginx:
              image: nginx:alpine
              container_name: shellsight-nginx
              restart: unless-stopped
              ports:
                - "${HTTP_PORT:-80}:80"
              volumes:
                - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
              depends_on:
                app:
                  condition: service_healthy
              networks:
                - shellsight-network

          networks:
            shellsight-network:
              driver: bridge
          EOF

          # Update deploy script for pre-built image
          cat > release-package/deploy.sh << 'DEPLOY_EOF'
          #!/bin/bash
          set -e

          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          NC='\033[0m'

          echo -e "${GREEN}========================================${NC}"
          echo -e "${GREEN}  ShellSight Deployment Script${NC}"
          echo -e "${GREEN}  Version: ${{ steps.version.outputs.VERSION }}${NC}"
          echo -e "${GREEN}========================================${NC}"
          echo

          # Check Docker
          if ! command -v docker &> /dev/null; then
              echo -e "${RED}Error: Docker is not installed.${NC}"
              exit 1
          fi

          # Check docker compose
          if command -v docker-compose &> /dev/null; then
              COMPOSE_CMD="docker-compose"
          elif docker compose version &> /dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
          else
              echo -e "${RED}Error: Docker Compose is not installed.${NC}"
              exit 1
          fi

          echo -e "${GREEN}✓ Docker is installed${NC}"
          echo -e "${GREEN}✓ Docker Compose is available${NC}"
          echo

          # Setup .env
          if [ ! -f .env ]; then
              echo -e "${YELLOW}Creating .env from template...${NC}"
              cp .env.example .env

              # Generate secrets
              SESSION_SECRET=$(openssl rand -hex 32 2>/dev/null || head -c 64 /dev/urandom | base64 | tr -d '\n' | head -c 64)
              JWT_SECRET=$(openssl rand -hex 32 2>/dev/null || head -c 64 /dev/urandom | base64 | tr -d '\n' | head -c 64)

              if [[ "$OSTYPE" == "darwin"* ]]; then
                  sed -i '' "s/SESSION_SECRET=change-me-to-a-random-string/SESSION_SECRET=$SESSION_SECRET/" .env
                  sed -i '' "s/JWT_SECRET=change-me-to-another-random-string/JWT_SECRET=$JWT_SECRET/" .env
              else
                  sed -i "s/SESSION_SECRET=change-me-to-a-random-string/SESSION_SECRET=$SESSION_SECRET/" .env
                  sed -i "s/JWT_SECRET=change-me-to-another-random-string/JWT_SECRET=$JWT_SECRET/" .env
              fi

              echo -e "${GREEN}✓ Created .env with generated secrets${NC}"
              echo
              echo -e "${YELLOW}Please edit .env to configure S3 storage and authentication${NC}"
              read -p "Press Enter to continue after editing .env..."
          fi

          echo
          echo -e "${GREEN}Pulling and starting containers...${NC}"
          $COMPOSE_CMD pull
          $COMPOSE_CMD up -d

          echo
          echo -e "${GREEN}========================================${NC}"
          echo -e "${GREEN}  Deployment Complete!${NC}"
          echo -e "${GREEN}========================================${NC}"
          echo
          echo "ShellSight is running at: http://localhost"
          echo
          echo "Commands:"
          echo "  Logs:    $COMPOSE_CMD logs -f"
          echo "  Stop:    $COMPOSE_CMD down"
          echo "  Restart: $COMPOSE_CMD restart"
          DEPLOY_EOF

          chmod +x release-package/deploy.sh

          # Create tarball
          tar -czvf shellsight-${{ steps.version.outputs.VERSION }}.tar.gz -C release-package .

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ShellSight ${{ steps.version.outputs.VERSION }}

          ### Quick Deployment

          #### Option 1: Using the deployment package (Recommended)

          ```bash
          # Download and extract
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/shellsight-${{ steps.version.outputs.VERSION }}.tar.gz
          tar -xzvf shellsight-${{ steps.version.outputs.VERSION }}.tar.gz
          cd shellsight-${{ steps.version.outputs.VERSION }}

          # Deploy
          ./deploy.sh
          ```

          #### Option 2: Using Docker directly

          ```bash
          # Pull the image
          docker pull ghcr.io/${{ github.repository }}:${{ steps.version.outputs.VERSION }}

          # Run with docker-compose (download docker-compose.yml from release assets)
          docker compose up -d
          ```

          ### Docker Image

          ```
          ghcr.io/${{ github.repository }}:${{ steps.version.outputs.VERSION }}
          ghcr.io/${{ github.repository }}:latest
          ```

          ### Configuration

          Edit `.env` file to configure:
          - **S3 Storage**: `S3_BUCKET`, `S3_ENDPOINT`, `S3_ACCESS_KEY`, `S3_SECRET_KEY`
          - **Authentication**: Set `AUTH_DISABLED=true` or configure OAuth providers
          - **URLs**: `BASE_URL`, `FRONTEND_URL` for your domain

          ### What's Included

          - Pre-built Docker image with frontend and backend
          - nginx reverse proxy configuration
          - Deployment script with automatic secret generation
          - Environment template with all configuration options

          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          files: |
            shellsight-${{ steps.version.outputs.VERSION }}.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
